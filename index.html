<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA / iOS Optimization -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å®¶è¨ˆç°¿">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2652/2652234.png">
    
    <title>Budget Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #000000;
            color: #f1f5f9;
            overscroll-behavior-y: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .safe-pt { padding-top: calc(0.5rem + var(--safe-top)); }
        .safe-pb { padding-bottom: calc(1rem + var(--safe-bottom)); }
        .safe-mb { margin-bottom: var(--safe-bottom); }
        
        .active-scale:active { transform: scale(0.96); transition: 0.1s; }

        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes fade-in { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.25s ease-out; }

        .view-hidden { display: none !important; }
        ::-webkit-scrollbar { display: none; }

        .category-chip {
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .category-chip.active {
            background-color: #2563eb;
            border-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .tab-bar {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        .tab-item {
            color: #64748b;
            transition: all 0.2s;
        }
        .tab-item.active {
            color: #3b82f6;
        }

        .progress-container {
            height: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease-out;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥ãƒˆãƒ¼ã‚¹ãƒˆ */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            background: #2563eb;
            color: white;
            padding: 12px 24px;
            border-radius: 99px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            transition: all 0.3s;
            opacity: 0;
            pointer-events: none;
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(10px); }
    </style>
</head>
<body class="min-h-screen">

    <div id="toast">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>

    <!-- VIEW 1: ãƒ¡ã‚¤ãƒ³ -->
    <div id="view-main" class="animate-fade-in min-h-screen pb-40">
        <header class="bg-black/60 border-b border-white/5 sticky top-0 z-30 backdrop-blur-xl safe-pt px-6 pb-4">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <div>
                    <p id="main-cycle-range" class="text-[11px] font-black text-gray-500 tracking-widest">--/-- ~ --/--</p>
                    <span id="main-cycle-badge" class="text-[9px] bg-white/5 text-gray-400 px-1.5 py-0.5 rounded-md border border-white/5 font-bold">--æ—¥é–“</span>
                </div>
                <button id="settingsBtn" class="p-2 hover:bg-white/10 rounded-full transition active-scale">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </header>

        <main class="max-w-md mx-auto px-4 mt-6 space-y-8">
            <section>
                <div class="glass-card p-7 rounded-[2.5rem] shadow-2xl relative overflow-hidden bg-gradient-to-br from-slate-800 to-slate-900 border border-white/10">
                    <div class="relative z-10 space-y-6">
                        <div class="flex justify-between items-start">
                            <div class="space-y-1">
                                <p class="text-[10px] text-blue-400 font-black uppercase tracking-[0.2em]">æœ¬æ—¥äºˆç®—</p>
                                <span class="text-4xl font-bold text-white tracking-tight" id="main-daily-allowance">Â¥0</span>
                            </div>
                            <div class="text-right space-y-1">
                                <p class="text-[10px] text-gray-500 font-black uppercase tracking-[0.2em]">æœ¬æ—¥æ”¯å‡º</p>
                                <span class="text-4xl font-bold text-gray-300 tracking-tight" id="main-spent-today">Â¥0</span>
                            </div>
                        </div>
                        <div class="bg-black/40 rounded-3xl p-5 border border-white/5 text-center">
                            <p class="text-[11px] text-gray-400 font-bold uppercase tracking-[0.2em] mb-1">æœ¬æ—¥ã®ä½™å‰°è³‡é‡‘</p>
                            <span class="text-3xl font-black" id="main-today-balance">Â¥0</span>
                        </div>
                        <div id="savings-deduction-info" class="view-hidden bg-blue-600/10 border border-blue-500/20 rounded-2xl p-3 flex justify-between items-center">
                            <p class="text-[9px] text-blue-400 font-bold uppercase tracking-widest">è¨ˆç”»è²¯é‡‘ã«ã‚ˆã‚‹å¤©å¼•ãä¸­</p>
                            <p class="text-xs font-black text-blue-300" id="main-monthly-plan-total">- Â¥0</p>
                        </div>
                        <div class="pt-4 border-t border-white/10 flex justify-between items-center">
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase font-black tracking-wider mb-1">ä»Šæœˆä½™å‰°è³‡é‡‘</p>
                                <p class="text-2xl font-bold text-gray-100" id="main-remaining-budget">Â¥0</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-gray-500 uppercase font-black tracking-wider mb-1">ç· ã‚ã¾ã§æ®‹ã‚Š</p>
                                <p class="text-2xl font-bold text-gray-100" id="main-days-left">--æ—¥</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section class="grid grid-cols-2 gap-4">
                <div id="main-trigger-variable" class="bg-slate-900/60 p-6 rounded-[2.2rem] border border-white/5 shadow-inner active-scale cursor-pointer hover:bg-slate-800 transition-colors relative">
                    <p class="text-[10px] uppercase tracking-widest text-gray-500 font-black mb-1">å¤‰å‹•è²»åˆè¨ˆ â†—</p>
                    <p class="text-xl font-black text-rose-500" id="main-total-variable">Â¥0</p>
                </div>
                <div id="main-trigger-savings" class="bg-slate-900/60 p-6 rounded-[2.2rem] border border-white/5 shadow-inner active-scale cursor-pointer hover:bg-slate-800 transition-colors relative">
                    <p class="text-[10px] uppercase tracking-widest text-gray-500 font-black mb-1">è²¯è“„ã‹ã‚‰åˆè¨ˆ â†—</p>
                    <p class="text-xl font-black text-amber-500" id="main-total-savings">Â¥0</p>
                </div>
            </section>
            <section class="space-y-4">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-[11px] font-black text-gray-500 uppercase tracking-[0.2em]">Recently Records</h2>
                    <div class="h-px flex-1 bg-white/5 mx-4"></div>
                </div>
                <div id="main-history-list" class="space-y-3"></div>
            </section>
        </main>
    </div>

    <!-- VIEW 2: æœªæ¥è¨ˆç”» -->
    <div id="view-plan" class="view-hidden animate-fade-in min-h-screen pb-40">
        <header class="bg-black/60 border-b border-white/5 sticky top-0 z-30 backdrop-blur-xl safe-pt px-6 pb-4 text-center">
            <h1 class="text-lg font-black tracking-widest text-white uppercase">Future Planning</h1>
        </header>
        <main class="max-w-md mx-auto px-4 mt-6 space-y-8">
            <section>
                <div class="glass-card p-7 rounded-[2.5rem] bg-gradient-to-br from-blue-900/40 to-indigo-900/40 border border-blue-500/20 text-center shadow-xl">
                    <p class="text-[10px] text-blue-400 font-black uppercase tracking-[0.2em] mb-2">ä»Šæœˆã®ç›®æ¨™è²¯é‡‘é¡</p>
                    <p class="text-4xl font-black text-white mb-2" id="plan-monthly-total">Â¥0</p>
                    <p class="text-[9px] text-gray-500 font-bold leading-relaxed tracking-wider">ã“ã‚Œã‚‰ã¯ãƒ¡ã‚¤ãƒ³ç”»é¢ã®äºˆç®—ã‹ã‚‰<br>è‡ªå‹•çš„ã«å¤©å¼•ãã•ã‚Œã¦ã„ã¾ã™</p>
                </div>
            </section>
            <section class="space-y-4">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-[11px] font-black text-gray-500 uppercase tracking-[0.2em]">Goal Lists</h2>
                    <button id="addPlanBtn" class="bg-blue-600 text-white text-[10px] font-black px-4 py-2 rounded-xl active-scale shadow-lg">ï¼‹æ–°è¦ä½œæˆ</button>
                </div>
                <div id="plan-list" class="space-y-4"></div>
            </section>
        </main>
    </div>

    <!-- UIå…±é€šãƒ‘ãƒ¼ãƒ„ -->
    <nav id="bottom-tabs" class="fixed bottom-0 left-0 right-0 z-40 tab-bar safe-pb">
        <div class="max-w-md mx-auto flex justify-around items-center h-16">
            <button id="tabItemMain" class="tab-item flex flex-col items-center gap-1 active">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                <span class="text-[9px] font-black uppercase tracking-widest">Home</span>
            </button>
            <button id="tabItemPlan" class="tab-item flex flex-col items-center gap-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                <span class="text-[9px] font-black uppercase tracking-widest">Plan</span>
            </button>
        </div>
    </nav>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: é›†è¨ˆ -->
    <div id="view-summary" class="view-hidden animate-fade-in min-h-screen pb-10">
        <header class="bg-black/60 sticky top-0 z-30 backdrop-blur-xl safe-pt px-6 pb-4 border-b border-white/5">
            <div class="max-w-md mx-auto flex items-center gap-4">
                <button id="backBtnSummary" class="p-2 -ml-2 text-gray-400 active-scale"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg></button>
                <h1 id="summary-title" class="text-lg font-black tracking-tight text-white">é›†è¨ˆ</h1>
            </div>
        </header>
        <main class="max-w-md mx-auto px-4 mt-6 space-y-6">
            <div class="glass-card rounded-[2rem] p-5 flex items-center justify-between shadow-lg">
                <button id="prevMonthBtn" class="p-3 text-gray-500 active-scale hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M15 19l-7-7 7-7"/></svg></button>
                <div class="text-center">
                    <p id="summary-cycle-range" class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-0.5">--/-- ~ --/--</p>
                    <p id="summary-month-label" class="text-sm font-black text-white">2024å¹´ 2æœˆåˆ†</p>
                </div>
                <button id="nextMonthBtn" class="p-3 text-gray-500 active-scale hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M9 5l7 7-7 7"/></svg></button>
            </div>
            <div id="summary-category-list" class="space-y-3"></div>
        </main>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: è©³ç´° -->
    <div id="view-detail" class="view-hidden animate-fade-in min-h-screen pb-10">
        <header class="bg-black/60 sticky top-0 z-30 backdrop-blur-xl safe-pt px-6 pb-4 border-b border-white/5">
            <div class="max-w-md mx-auto flex items-center gap-4">
                <button id="backBtnDetail" class="p-2 -ml-2 text-gray-400 active-scale"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg></button>
                <h1 id="detail-title" class="text-lg font-black tracking-tight text-white">è©³ç´°</h1>
            </div>
        </header>
        <main class="max-w-md mx-auto px-4 mt-6"><div id="detail-transaction-list" class="space-y-3"></div></main>
    </div>

    <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ -->
    <div id="fab-container" class="fixed bottom-20 left-0 right-0 pointer-events-none flex justify-center z-40">
        <button id="addBtn" class="pointer-events-auto w-16 h-16 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center active-scale border-[5px] border-black hover:bg-blue-500 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6v12m6-6H6" /></svg>
        </button>
    </div>

    <!-- è¨­å®š & ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå¯¾å¿œï¼‰ -->
    <div id="settingsModal" class="fixed inset-0 bg-black/95 z-50 flex items-center justify-center hidden p-4 backdrop-blur-xl">
        <div class="bg-slate-950 w-full max-w-sm rounded-[3rem] p-10 space-y-10 border border-white/10 safe-pb max-h-[90vh] overflow-y-auto shadow-2xl">
            <h3 class="text-2xl font-black text-center text-white tracking-tight">Settings</h3>
            
            <!-- äºˆç®—ãƒ»ã‚µã‚¤ã‚¯ãƒ« -->
            <div class="space-y-8">
                <div><label class="text-[10px] text-gray-500 font-black uppercase block">æœˆé–“äºˆç®— (Â¥)</label><input type="number" id="monthlyBudgetInput" class="w-full text-3xl font-black border-b-2 border-white/5 bg-transparent text-white outline-none py-3"></div>
                <div><label class="text-[10px] text-gray-500 font-black uppercase block">ã‚µã‚¤ã‚¯ãƒ«ã®é–‹å§‹æ—¥</label><input type="number" id="startDayInput" min="1" max="31" class="w-24 text-3xl font-black border-b-2 border-white/5 bg-transparent text-white outline-none py-3 text-center"></div>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ©Ÿèƒ½ï¼ˆã“ã“ã§ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã„ã¾ã™ï¼‰ -->
            <div class="space-y-4 pt-6 border-t border-white/5">
                <label class="text-[10px] text-gray-500 font-black uppercase block tracking-widest">å…¨ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬ç§»è¡Œ (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)</label>
                <div class="grid grid-cols-2 gap-3">
                    <button id="exportBtn" class="bg-white/5 text-gray-300 py-4 rounded-2xl text-[10px] font-black border border-white/5 active-scale">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼</button>
                    <button id="importBtn" class="bg-blue-600 text-white py-4 rounded-2xl text-[10px] font-black shadow-lg active-scale">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ</button>
                </div>
                <p class="text-[9px] text-gray-600 leading-relaxed px-1">
                    æ”¯å‡ºå±¥æ­´ã€è²¯é‡‘è¨ˆç”»ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€äºˆç®—è¨­å®šã®<b>ã™ã¹ã¦</b>ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚åˆ¥ã®URLã«ç§»ã‚‹éš›ã¯ã“ã®ãƒœã‚¿ãƒ³ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
                </p>
            </div>

            <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç† -->
            <div class="space-y-6 pt-6 border-t border-white/5">
                <label class="text-[10px] text-gray-500 font-black uppercase block tracking-widest">Categories</label>
                <div id="catManageVar" class="space-y-3"></div>
                <div id="catManageSav" class="space-y-3"></div>
            </div>

            <button id="clearBtn" class="w-full py-4 text-[10px] font-black text-rose-800 transition uppercase tracking-widest">Clear Data</button>
            <div class="flex gap-4 pt-4">
                <button id="closeSettings" class="flex-1 bg-white/5 text-gray-400 py-5 rounded-[2rem] font-bold">æˆ»ã‚‹</button>
                <button id="saveSettings" class="flex-1 bg-blue-600 text-white py-5 rounded-[2.5rem] font-black shadow-lg">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="importModal" class="fixed inset-0 bg-black/95 z-[120] flex items-center justify-center hidden p-4 backdrop-blur-xl">
        <div class="bg-slate-900 w-full max-w-sm rounded-[3rem] p-8 space-y-6 border border-white/10 shadow-2xl">
            <h3 class="text-lg font-bold text-white text-center">ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ</h3>
            <p class="text-xs text-gray-400">ã€Œå…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã€ã§å–å¾—ã—ãŸå†…å®¹ã‚’ä»¥ä¸‹ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
            <textarea id="importArea" class="w-full h-40 bg-black border border-white/10 rounded-2xl p-4 text-[9px] text-blue-400 font-mono outline-none" placeholder="ã“ã“ã«è²¼ã‚Šä»˜ã‘..."></textarea>
            <div class="flex gap-3">
                <button id="closeImportModal" class="flex-1 bg-white/5 text-gray-400 py-4 rounded-2xl font-bold">ä¸­æ­¢</button>
                <button id="confirmImport" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg">å¾©å…ƒã‚’å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <!-- æ”¯å‡ºå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ãªã©ã¯æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶™æ‰¿ -->
    <div id="entryModal" class="fixed inset-0 bg-black/90 z-50 flex items-end justify-center hidden backdrop-blur-md">
        <div class="bg-slate-950 w-full max-w-md rounded-t-[3rem] p-8 pb-12 space-y-8 border-t border-white/10 safe-pb shadow-2xl">
            <div class="flex justify-between items-center"><h3 id="modalTitle" class="text-xl font-black text-white">æ”¯å‡ºã‚’å…¥åŠ›</h3><button id="closeModal" class="text-gray-600 bg-white/5 p-2 rounded-full">&times;</button></div>
            <input type="hidden" id="editId">
            <div class="space-y-8">
                <div class="text-center"><label class="block text-[10px] text-gray-500 uppercase font-black">Amount</label><div class="flex items-center justify-center gap-2"><span class="text-3xl font-bold text-blue-500">Â¥</span><input type="number" id="amountInput" inputmode="numeric" placeholder="0" class="text-6xl font-black text-white bg-transparent border-none focus:ring-0 outline-none w-64 text-center"></div></div>
                <div class="space-y-4"><div class="bg-white/5 rounded-2xl p-4 flex justify-between"><label class="text-[10px] text-gray-500 font-black">Date</label><input type="date" id="dateInput" class="bg-transparent text-white font-bold outline-none"></div><input type="text" id="memoInput" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰" class="w-full bg-white/5 px-6 py-5 rounded-2xl outline-none text-white text-lg font-medium border border-white/5"></div>
                <div class="flex p-1 bg-black rounded-2xl border border-white/10"><button class="type-tab-btn flex-1 py-3 rounded-xl font-black text-[10px]" data-type="variable" id="tabVar">ğŸ›’ å¤‰å‹•è²»</button><button class="type-tab-btn flex-1 py-3 rounded-xl font-black text-[10px]" data-type="savings" id="tabSav">ğŸ’° è²¯è“„ã‹ã‚‰</button></div>
                <div id="categoryGrid" class="flex flex-wrap gap-2.5"></div>
                <div class="flex gap-4 pt-6"><button id="deleteEntryBtn" class="hidden flex-1 bg-rose-500/10 text-rose-500 font-black py-5 rounded-[2rem]">å‰Šé™¤</button><button id="saveBtn" class="flex-[3] bg-blue-600 text-white font-black py-5 rounded-[2.5rem] shadow-xl text-lg">ä¿å­˜</button></div>
            </div>
        </div>
    </div>

    <!-- æœªæ¥è¨ˆç”»ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="planModal" class="fixed inset-0 bg-black/95 z-[60] flex items-center justify-center hidden p-4 backdrop-blur-xl">
        <div class="bg-slate-900 w-full max-w-sm rounded-[3rem] p-8 space-y-6 border border-white/10 shadow-2xl">
            <h3 class="text-xl font-black text-center text-white" id="planModalTitle">è¨ˆç”»</h3>
            <div class="space-y-4">
                <div><label class="text-[10px] text-gray-500 font-black uppercase">ç›®æ¨™åç§°</label><input type="text" id="planNameInput" placeholder="åç§°" class="w-full bg-white/5 rounded-2xl px-5 py-4 outline-none text-white font-bold border border-white/5"></div>
                <div><label class="text-[10px] text-gray-500 font-black uppercase">ç›®æ¨™é‡‘é¡ (Â¥)</label><input type="number" id="planTargetInput" inputmode="numeric" placeholder="0" class="w-full bg-white/5 rounded-2xl px-5 py-4 outline-none text-white font-black border border-white/5"></div>
                <div><label class="text-[10px] text-gray-500 font-black uppercase">ç¾åœ¨ã®è²¯é‡‘é¡ (Â¥)</label><input type="number" id="planCurrentInput" inputmode="numeric" placeholder="0" class="w-full bg-white/5 rounded-2xl px-5 py-4 outline-none text-white font-black border border-white/5"></div>
                <div><label class="text-[10px] text-gray-500 font-black uppercase">è²¯ã‚ãã‚ŠãŸã„æ—¥</label><input type="date" id="planDateInput" class="w-full bg-white/5 rounded-2xl px-5 py-4 outline-none text-white font-bold border border-white/5"></div>
            </div>
            <div class="flex gap-3 pt-4"><button id="deletePlanBtn" class="view-hidden flex-1 bg-rose-500/10 text-rose-500 py-4 rounded-2xl font-bold">å‰Šé™¤</button><button id="closePlanModal" class="flex-1 bg-white/5 text-gray-400 py-4 rounded-2xl font-bold">ä¸­æ­¢</button><button id="confirmAddPlan" class="flex-[2] bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg">ä¿å­˜</button></div>
        </div>
    </div>

    <!-- å‰Šé™¤ç¢ºèªï¼ˆå…±é€šï¼‰ -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black/95 z-[110] flex items-center justify-center hidden p-6 backdrop-blur-xl"><div class="bg-slate-900 w-full max-w-xs rounded-[2.5rem] p-10 space-y-8 border border-rose-500/20 text-center"><div class="w-16 h-16 bg-rose-500/10 text-rose-500 rounded-full flex items-center justify-center mx-auto text-2xl font-bold">!</div><h3 class="text-lg font-bold text-white">å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h3><div class="space-y-3"><button id="confirmDeleteAction" class="w-full bg-rose-600 text-white py-4 rounded-2xl font-black shadow-lg active-scale">å‰Šé™¤ã™ã‚‹</button><button id="cancelDeleteAction" class="w-full bg-white/5 text-gray-400 py-4 rounded-2xl font-bold active-scale">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div></div>
    
    <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼è¿½åŠ ç”¨ãƒŸãƒ‹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="catInputModal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center hidden p-4 backdrop-blur-xl"><div class="bg-slate-900 w-full max-w-xs rounded-[2.5rem] p-8 space-y-6 border border-white/10 shadow-2xl"><h3 class="text-lg font-bold text-center text-white">ã‚«ãƒ†ã‚´ãƒªãƒ¼è¿½åŠ </h3><input type="text" id="newCatNameInput" placeholder="åç§°" class="w-full bg-white/5 rounded-2xl px-6 py-4 outline-none text-white text-lg border border-white/5 focus:border-blue-500"><div class="flex gap-3"><button id="closeCatInputModal" class="flex-1 bg-white/5 text-gray-400 py-4 rounded-2xl font-bold">ä¸­æ­¢</button><button id="confirmAddCat" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg">æ±ºå®š</button></div></div></div>

    <script>
        // ==========================================
        // STATE & STORAGE (STORAGE_KEYã‚’çµ±ä¸€ã—ã¦ä¸€æ‹¬ç®¡ç†)
        // ==========================================
        let appState = {
            monthlyBudget: 50000, startDay: 25,
            categories: { variable: ["ä»•äº‹é£Ÿè²»", "é£Ÿè²»", "æ—¥ç”¨å“", "äº¤é€šè²»", "è¶£å‘³"], savings: ["è²¯é‡‘", "æ—…è²»äº¤é€šè²»", "ç—…é™¢", "è‡ªå·±æŠ•è³‡"] },
            transactions: [], plans: []
        };
        const STORAGE_KEY = 'budget_pro_final_all_data'; // ã‚­ãƒ¼ã‚’çµ±åˆ
        let viewHistory = ['view-main'], currentType = 'variable', selectedCategory = '', editingId = null, editingPlanId = null;
        let summaryContext = { type: 'variable', date: new Date() }, detailContext = { category: '', type: 'variable' }, targetCatAddType = 'variable';

        const saveToStorage = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
        const loadFromStorage = () => { 
            const saved = localStorage.getItem(STORAGE_KEY); 
            if (saved) { appState = { ...appState, ...JSON.parse(saved) }; } 
        };

        // é€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // ==========================================
        // LOGIC & UI (æ—¢å­˜ã®ã‚‚ã®ã‚’çµ±åˆ)
        // ==========================================
        function getCycleInfo(specificDate = new Date()) {
            let year = specificDate.getFullYear(), month = specificDate.getMonth();
            if (specificDate.getDate() < appState.startDay) month--;
            let start = new Date(year, month, appState.startDay);
            if (start.getMonth() !== (month + 12) % 12) start = new Date(year, month + 1, 0);
            start.setHours(0,0,0,0);
            let end = new Date(start.getFullYear(), start.getMonth() + 1, start.getDate());
            end.setDate(end.getDate() - 1); end.setHours(23,59,59,999);
            const today = new Date(); today.setHours(0,0,0,0);
            const diffTime = end.getTime() - today.getTime();
            const daysLeft = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
            const totalDays = Math.round((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24)) + 1;
            return { start, end, daysLeft, totalDays, rangeText: `${start.getMonth()+1}/${start.getDate()} ~ ${end.getMonth()+1}/${end.getDate()}` };
        }

        function getMonthlyPlanRequirement() {
            let totalMonthImpact = 0; const today = new Date(); today.setHours(0,0,0,0);
            const currentCycle = getCycleInfo();
            appState.plans.forEach(p => {
                const targetDate = new Date(p.deadline); targetDate.setHours(23,59,59,999);
                const remainingAmount = Math.max(0, p.target - p.current);
                if (remainingAmount <= 0) return;
                const diffTime = targetDate.getTime() - today.getTime();
                const daysUntilDeadline = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
                const dailyRate = remainingAmount / daysUntilDeadline;
                if (targetDate <= currentCycle.end) { totalMonthImpact += remainingAmount; } 
                else { totalMonthImpact += Math.min(remainingAmount, Math.floor(dailyRate * 30)); }
            });
            return totalMonthImpact;
        }

        const formatDateForInput = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        function safeUpdate(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }

        function navigateTo(viewId) {
            document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('view-hidden'));
            const target = document.getElementById(viewId);
            if (target) {
                target.classList.remove('view-hidden');
                if (viewHistory[viewHistory.length - 1] !== viewId) viewHistory.push(viewId);
                updateUI();
            }
        }
        function navigateBack() { if (viewHistory.length > 1) { viewHistory.pop(); navigateTo(viewHistory[viewHistory.length - 1]); } }
        function switchTab(tabId) {
            viewHistory = [`view-${tabId}`];
            document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('view-hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('view-hidden');
            document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
            const id = `tabItem${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`;
            const el = document.getElementById(id); if(el) el.classList.add('active');
            document.getElementById('fab-container').classList.toggle('view-hidden', tabId !== 'main');
            updateUI();
        }

        function updateUI() {
            const view = viewHistory[viewHistory.length - 1];
            if (view === 'view-main') renderMain();
            else if (view === 'view-plan') renderPlan();
            else if (view === 'view-summary') renderSummary();
            else if (view === 'view-detail') renderDetail();
        }

        function renderMain() {
            const cycle = getCycleInfo(), planTotal = getMonthlyPlanRequirement(), todayStr = formatDateForInput(new Date());
            let varTotal = 0, savTotal = 0, spentToday = 0;
            appState.transactions.forEach(t => {
                if (t.timestamp >= cycle.start.getTime() && t.timestamp <= cycle.end.getTime()) {
                    if (t.type === 'variable') varTotal += t.amount; else savTotal += t.amount;
                }
                if (t.type === 'variable' && formatDateForInput(new Date(t.timestamp)) === todayStr) spentToday += t.amount;
            });
            const remaining = appState.monthlyBudget - varTotal - planTotal;
            const daily = Math.floor(remaining / cycle.daysLeft);
            const todaySurplus = Math.floor((remaining + spentToday) / cycle.daysLeft) - spentToday;
            safeUpdate('main-cycle-range', cycle.rangeText); safeUpdate('main-cycle-badge', `${cycle.totalDays}æ—¥é–“`);
            safeUpdate('main-daily-allowance', `Â¥${daily.toLocaleString()}`); safeUpdate('main-spent-today', `Â¥${spentToday.toLocaleString()}`);
            safeUpdate('main-today-balance', `Â¥${todaySurplus.toLocaleString()}`);
            const balEl = document.getElementById('main-today-balance'); if (balEl) balEl.className = `text-3xl font-black ${todaySurplus < 0 ? 'text-rose-500' : 'text-blue-400'}`;
            safeUpdate('main-remaining-budget', `Â¥${remaining.toLocaleString()}`); safeUpdate('main-days-left', `${cycle.daysLeft}æ—¥`);
            safeUpdate('main-total-variable', `Â¥${varTotal.toLocaleString()}`); safeUpdate('main-total-savings', `Â¥${savTotal.toLocaleString()}`);
            const infoEl = document.getElementById('savings-deduction-info'); if (infoEl) { infoEl.classList.toggle('view-hidden', planTotal <= 0); safeUpdate('main-monthly-plan-total', `- Â¥${planTotal.toLocaleString()}`); }
            const list = document.getElementById('main-history-list'); if (list) {
                const recent = [...appState.transactions].sort((a,b) => b.timestamp - a.timestamp).slice(0, 5);
                list.innerHTML = recent.length ? '' : '<p class="text-center py-10 text-gray-700 text-[10px] font-black italic">NO RECORDS</p>';
                recent.forEach(t => list.appendChild(createRow(t)));
            }
        }

        function renderPlan() {
            const planTotal = getMonthlyPlanRequirement(); safeUpdate('plan-monthly-total', `Â¥${planTotal.toLocaleString()}`);
            const list = document.getElementById('plan-list'); if (!list) return; list.innerHTML = '';
            if (appState.plans.length === 0) { list.innerHTML = '<p class="text-center py-20 text-gray-700 text-xs italic font-bold">ç¾åœ¨è¨ˆç”»ä¸­ã®æ”¯å‡ºã¯ã‚ã‚Šã¾ã›ã‚“</p>'; return; }
            const today = new Date(); today.setHours(0,0,0,0); const currentCycle = getCycleInfo();
            appState.plans.forEach((p, idx) => {
                const targetDate = new Date(p.deadline); targetDate.setHours(23,59,59,999);
                const remainingAmount = Math.max(0, p.target - p.current);
                const diffTime = targetDate.getTime() - today.getTime();
                const daysUntilDeadline = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
                let mReq = (targetDate <= currentCycle.end) ? remainingAmount : Math.min(remainingAmount, Math.floor((remainingAmount / daysUntilDeadline) * 30));
                const progress = Math.min(100, Math.round((p.current / p.target) * 100)) || 0;
                const card = document.createElement('div'); card.className = "glass-card p-6 rounded-[2rem] space-y-4 border border-white/5 active-scale cursor-pointer relative overflow-hidden shadow-lg";
                card.onclick = () => editPlan(idx);
                card.innerHTML = `<div class="flex justify-between items-start relative z-10"><div><h3 class="font-black text-white text-lg leading-tight">${p.name}</h3><p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mt-1">${p.deadline.replace(/-/g, '/')} ã¾ã§</p></div><div class="text-right"><p class="text-[10px] text-blue-400 font-black mb-1 uppercase text-right">Required Monthly</p><p class="text-xl font-black text-white">Â¥${Math.floor(mReq).toLocaleString()}</p></div></div><div class="space-y-2 relative z-10"><div class="flex justify-between items-end"><p class="text-[9px] font-black text-gray-400 uppercase tracking-tighter">${progress}% Saved</p><p class="text-[10px] font-bold text-gray-200">Â¥${p.current.toLocaleString()} / Â¥${p.target.toLocaleString()}</p></div><div class="progress-container"><div class="progress-fill bg-blue-500" style="width: ${progress}%"></div></div></div><div class="flex justify-between items-center pt-1 relative z-10"><span class="text-[9px] text-gray-500 font-bold">æ®‹ã‚Š ${daysUntilDeadline} æ—¥</span></div>`;
                list.appendChild(card);
            });
        }

        function renderSummary() {
            const cycle = getCycleInfo(summaryContext.date), isVar = summaryContext.type === 'variable';
            safeUpdate('summary-title', isVar ? 'å¤‰å‹•è²»ã®é›†è¨ˆ' : 'è²¯è“„ã‹ã‚‰ã®é›†è¨ˆ'); safeUpdate('summary-cycle-range', cycle.rangeText); safeUpdate('summary-month-label', `${cycle.start.getFullYear()}å¹´ ${cycle.start.getMonth()+1}æœˆåˆ†`);
            const totals = {}; appState.categories[summaryContext.type].forEach(c => totals[c] = 0);
            appState.transactions.filter(t => t.type === summaryContext.type && t.timestamp >= cycle.start.getTime() && t.timestamp <= cycle.end.getTime()).forEach(t => { if(totals[t.category] !== undefined) totals[t.category] += t.amount; });
            const list = document.getElementById('summary-category-list'); if (!list) return; list.innerHTML = '';
            Object.entries(totals).sort((a,b) => b[1] - a[1]).forEach(([name, total]) => {
                const div = document.createElement('div'); div.className = "glass-card p-5 rounded-[1.8rem] flex items-center justify-between active-scale cursor-pointer border border-white/5 shadow-md";
                div.onclick = () => { detailContext = { category: name, type: summaryContext.type }; navigateTo('view-detail'); };
                div.innerHTML = `<div class="flex items-center gap-4"><div class="w-10 h-10 rounded-xl ${isVar ? 'bg-rose-500/10 text-rose-500' : 'bg-amber-500/10 text-amber-500'} flex items-center justify-center text-[10px] font-black border border-white/5">${name.substring(0,2)}</div><p class="font-bold text-gray-200 text-sm">${name}</p></div><p class="font-black text-white text-lg">Â¥${total.toLocaleString()}</p>`;
                list.appendChild(div);
            });
        }

        function renderDetail() {
            const cycle = getCycleInfo(summaryContext.date); safeUpdate('detail-title', detailContext.category);
            const filtered = appState.transactions.filter(t => t.category === detailContext.category && t.type === detailContext.type && t.timestamp >= cycle.start.getTime() && t.timestamp <= cycle.end.getTime()).sort((a,b) => b.timestamp - a.timestamp);
            const list = document.getElementById('detail-transaction-list'); if (!list) return; list.innerHTML = filtered.length ? '' : '<p class="text-center py-20 text-gray-700 text-xs italic font-bold">NO DATA</p>';
            filtered.forEach(t => list.appendChild(createRow(t)));
        }

        function createRow(t) {
            const div = document.createElement('div'); div.className = "bg-slate-900/40 p-5 rounded-[1.8rem] flex items-center justify-between border border-white/5 active-scale shadow-sm";
            div.onclick = (e) => { e.stopPropagation(); openEditModal(t); }; const d = new Date(t.timestamp);
            div.innerHTML = `<div class="flex items-center gap-4"><div class="w-11 h-11 rounded-2xl ${t.type === 'variable' ? 'bg-blue-600/10 text-blue-500' : 'bg-amber-600/10 text-amber-400'} flex items-center justify-center text-[9px] font-black border border-white/5">${t.category.substring(0,2)}</div><div><p class="font-bold text-gray-100 text-[13px]">${t.memo || t.category}</p><p class="text-[9px] text-gray-600 font-black mt-1 uppercase">${d.getMonth()+1}/${d.getDate()} â€¢ ${t.category}</p></div></div><p class="font-bold text-gray-100 text-sm">Â¥${t.amount.toLocaleString()}</p>`;
            return div;
        }

        function renderCategoryManagement() {
            const renderList = (type, containerId) => {
                const container = document.getElementById(containerId); const color = type === 'variable' ? 'text-rose-500' : 'text-amber-500';
                container.innerHTML = `<div class="flex justify-between items-center mb-3"><p class="text-[9px] font-black ${color} tracking-widest uppercase">${type === 'variable' ? 'å¤‰å‹•è²»' : 'è²¯è“„ã‹ã‚‰'}</p><button id="addCatBtn-${type}" class="text-[10px] font-bold bg-white/5 px-3 py-1 rounded-lg border border-white/5 active-scale">ï¼‹è¿½åŠ </button></div>`;
                document.getElementById(`addCatBtn-${type}`).onclick = () => { targetCatAddType = type; document.getElementById('newCatNameInput').value = ''; document.getElementById('catInputModal').classList.remove('hidden'); };
                appState.categories[type].forEach((cat, idx) => {
                    const div = document.createElement('div'); div.className = "flex items-center gap-3 bg-black p-4 rounded-2xl border border-white/5 mb-2 shadow-sm";
                    div.innerHTML = `<input type="text" value="${cat}" class="flex-1 bg-transparent text-sm font-bold text-gray-200 outline-none" id="cat-input-${type}-${idx}"><button class="text-gray-700 hover:text-rose-500 text-xl font-black active-scale" id="cat-del-${type}-${idx}">&times;</button>`;
                    container.appendChild(div);
                    document.getElementById(`cat-input-${type}-${idx}`).onchange = (e) => { if (e.target.value.trim()) appState.categories[type][idx] = e.target.value.trim(); saveToStorage(); };
                    document.getElementById(`cat-del-${type}-${idx}`).onclick = () => { if (appState.categories[type].length > 1) { appState.categories[type].splice(idx, 1); saveToStorage(); renderCategoryManagement(); } };
                });
            }; renderList('variable', 'catManageVar'); renderList('savings', 'catManageSav');
        }

        // ==========================================
        // INITIALIZATION & EVENT BINDING
        // ==========================================
        function init() {
            loadFromStorage();
            
            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('tabItemMain').onclick = () => switchTab('main');
            document.getElementById('tabItemPlan').onclick = () => switchTab('plan');
            
            // ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('main-trigger-variable').onclick = () => { summaryContext = { type: 'variable', date: new Date() }; navigateTo('view-summary'); };
            document.getElementById('main-trigger-savings').onclick = () => { summaryContext = { type: 'savings', date: new Date() }; navigateTo('view-summary'); };
            document.getElementById('settingsBtn').onclick = () => { document.getElementById('monthlyBudgetInput').value = appState.monthlyBudget; document.getElementById('startDayInput').value = appState.startDay; renderCategoryManagement(); document.getElementById('settingsModal').classList.remove('hidden'); };
            
            // å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('addBtn').onclick = openAddModal;
            document.getElementById('closeModal').onclick = () => document.getElementById('entryModal').classList.add('hidden');
            document.getElementById('tabVar').onclick = () => switchType('variable');
            document.getElementById('tabSav').onclick = () => switchType('savings');
            document.getElementById('saveBtn').onclick = () => {
                const amt = parseInt(document.getElementById('amountInput').value); if (!amt || isNaN(amt)) return;
                const entry = { id: editingId || Date.now(), amount: amt, memo: document.getElementById('memoInput').value, type: currentType, category: selectedCategory, timestamp: new Date(document.getElementById('dateInput').value).getTime() };
                if (editingId) { const idx = appState.transactions.findIndex(x => x.id === editingId); appState.transactions[idx] = entry; } else appState.transactions.push(entry);
                saveToStorage(); updateUI(); document.getElementById('entryModal').classList.add('hidden');
            };

            // è¨­å®šä¿å­˜
            document.getElementById('saveSettings').onclick = () => { appState.monthlyBudget = parseInt(document.getElementById('monthlyBudgetInput').value) || 0; appState.startDay = parseInt(document.getElementById('startDayInput').value) || 1; saveToStorage(); updateUI(); document.getElementById('settingsModal').classList.add('hidden'); };
            document.getElementById('closeSettings').onclick = () => document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('clearBtn').onclick = () => { if (confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.clear(); location.reload(); } };

            // é›†è¨ˆãƒ»è©³ç´°æˆ»ã‚‹
            document.getElementById('backBtnSummary').onclick = navigateBack;
            document.getElementById('backBtnDetail').onclick = navigateBack;
            document.getElementById('prevMonthBtn').onclick = () => { summaryContext.date.setMonth(summaryContext.date.getMonth() - 1); updateUI(); };
            document.getElementById('nextMonthBtn').onclick = () => { summaryContext.date.setMonth(summaryContext.date.getMonth() + 1); updateUI(); };

            // è¨ˆç”»ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('addPlanBtn').onclick = openAddPlan;
            document.getElementById('closePlanModal').onclick = () => document.getElementById('planModal').classList.add('hidden');
            document.getElementById('confirmAddPlan').onclick = () => {
                const n = document.getElementById('planNameInput').value, t = parseInt(document.getElementById('planTargetInput').value), c = parseInt(document.getElementById('planCurrentInput').value) || 0, d = document.getElementById('planDateInput').value;
                if(!n || !t || !d) return;
                const p = { name: n, target: t, current: c, deadline: d };
                if(editingPlanId !== null) appState.plans[editingPlanId] = p; else appState.plans.push(p);
                saveToStorage(); updateUI(); document.getElementById('planModal').classList.add('hidden');
            };
            document.getElementById('deletePlanBtn').onclick = () => { if(editingPlanId !== null) { appState.plans.splice(editingPlanId, 1); saveToStorage(); updateUI(); document.getElementById('planModal').classList.add('hidden'); } };

            // --- ãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼ˆEXPORT/IMPORTï¼‰ ---
            document.getElementById('exportBtn').onclick = () => {
                const allData = localStorage.getItem(STORAGE_KEY);
                if (allData) {
                    const el = document.createElement('textarea');
                    el.value = allData;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    showToast("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
                } else {
                    showToast("ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
                }
            };

            document.getElementById('importBtn').onclick = () => {
                document.getElementById('importArea').value = '';
                document.getElementById('importModal').classList.remove('hidden');
            };

            document.getElementById('closeImportModal').onclick = () => document.getElementById('importModal').classList.add('hidden');

            document.getElementById('confirmImport').onclick = () => {
                try {
                    const raw = document.getElementById('importArea').value.trim();
                    if (!raw) return;
                    const parsed = JSON.parse(raw);
                    // å½¢å¼ãƒã‚§ãƒƒã‚¯
                    if (typeof parsed !== 'object') throw new Error();
                    localStorage.setItem(STORAGE_KEY, raw);
                    showToast("å¾©å…ƒã«æˆåŠŸã—ã¾ã—ãŸï¼");
                    setTimeout(() => location.reload(), 1000);
                } catch (e) {
                    showToast("ã‚¨ãƒ©ãƒ¼: æ­£ã—ã„å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
                }
            };

            // å‰Šé™¤ç¢ºèª
            document.getElementById('deleteEntryBtn').onclick = () => document.getElementById('deleteConfirmModal').classList.remove('hidden');
            document.getElementById('cancelDeleteAction').onclick = () => document.getElementById('deleteConfirmModal').classList.add('hidden');
            document.getElementById('confirmDeleteAction').onclick = () => { if (editingId) { appState.transactions = appState.transactions.filter(t => t.id !== editingId); saveToStorage(); updateUI(); document.getElementById('deleteConfirmModal').classList.add('hidden'); document.getElementById('entryModal').classList.add('hidden'); } };
            document.getElementById('closeCatInputModal').onclick = () => document.getElementById('catInputModal').classList.add('hidden');
            document.getElementById('confirmAddCat').onclick = () => { const val = document.getElementById('newCatNameInput').value.trim(); if (val) { appState.categories[targetCatAddType].push(val); saveToStorage(); renderCategoryManagement(); document.getElementById('catInputModal').classList.add('hidden'); } };

            updateUI();
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠã®è¡¨ç¤º
        function switchType(type) { currentType = type; document.getElementById('tabVar').className = `type-tab-btn flex-1 py-3 rounded-xl font-black text-[10px] transition-all ${type === 'variable' ? 'bg-slate-800 text-blue-400 shadow-xl' : 'text-gray-700'}`; document.getElementById('tabSav').className = `type-tab-btn flex-1 py-3 rounded-xl font-black text-[10px] transition-all ${type === 'savings' ? 'bg-slate-800 text-amber-400 shadow-xl' : 'text-gray-700'}`; selectedCategory = appState.categories[type][0]; renderCategoryGrid(); }
        function renderCategoryGrid() { const grid = document.getElementById('categoryGrid'); if(!grid) return; grid.innerHTML = ''; appState.categories[currentType].forEach(cat => { const btn = document.createElement('button'); btn.className = `category-chip px-5 py-3 rounded-2xl text-[10px] font-black transition-all ${selectedCategory === cat ? 'active' : 'bg-black text-gray-600'}`; btn.innerText = cat; btn.onclick = () => { selectedCategory = cat; renderCategoryGrid(); }; grid.appendChild(btn); }); }

        function openAddModal() { editingId = null; document.getElementById('modalTitle').innerText = "æ”¯å‡ºã‚’å…¥åŠ›"; document.getElementById('amountInput').value = ''; document.getElementById('memoInput').value = ''; document.getElementById('dateInput').value = formatDateForInput(new Date()); document.getElementById('deleteEntryBtn').classList.add('view-hidden'); document.getElementById('entryModal').classList.remove('hidden'); switchType('variable'); }
        function openEditModal(t) { editingId = t.id; document.getElementById('modalTitle').innerText = "è¨˜éŒ²ã‚’ç·¨é›†"; document.getElementById('amountInput').value = t.amount; document.getElementById('memoInput').value = t.memo; document.getElementById('dateInput').value = formatDateForInput(new Date(t.timestamp)); document.getElementById('deleteEntryBtn').classList.remove('view-hidden'); switchType(t.type); selectedCategory = t.category; renderCategoryGrid(); document.getElementById('entryModal').classList.remove('hidden'); }
        function openAddPlan() { editingPlanId = null; document.getElementById('planModalTitle').innerText = "è¨ˆç”»ã®è¿½åŠ "; document.getElementById('planNameInput').value = ''; document.getElementById('planTargetInput').value = ''; document.getElementById('planCurrentInput').value = '0'; const d = new Date(); d.setMonth(d.getMonth()+2); d.setDate(0); document.getElementById('planDateInput').value = formatDateForInput(d); document.getElementById('deletePlanBtn').classList.add('view-hidden'); document.getElementById('planModal').classList.remove('hidden'); }
        function editPlan(idx) { editingPlanId = idx; const p = appState.plans[idx]; document.getElementById('planModalTitle').innerText = "è¨ˆç”»ã®ç·¨é›†"; document.getElementById('planNameInput').value = p.name; document.getElementById('planTargetInput').value = p.target; document.getElementById('planCurrentInput').value = p.current; document.getElementById('planDateInput').value = p.deadline; document.getElementById('deletePlanBtn').classList.remove('view-hidden'); document.getElementById('planModal').classList.remove('hidden'); }

        window.onload = init;
    </script>
</body>
</html>