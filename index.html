<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA / iOS Optimization -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å®¶è¨ˆç°¿">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2652/2652234.png">
    
    <title>Budget Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #000000;
            color: #f1f5f9;
            overscroll-behavior-y: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .safe-pt { padding-top: calc(0.5rem + var(--safe-top)); }
        .safe-pb { padding-bottom: calc(1rem + var(--safe-bottom)); }
        .safe-mb { margin-bottom: var(--safe-bottom); }
        
        .active-scale:active { transform: scale(0.96); transition: 0.1s; }

        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes fade-in { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.25s ease-out; }

        .view-hidden { display: none !important; }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
        ::-webkit-scrollbar { display: none; }

        .category-chip {
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .category-chip.active {
            background-color: #2563eb;
            border-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- ==========================================
         VIEW 1: ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
         ========================================== -->
    <div id="view-main" class="animate-fade-in min-h-screen pb-32">
        <header class="bg-black/60 border-b border-white/5 sticky top-0 z-30 backdrop-blur-xl safe-pt px-6 pb-4">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <div>
                    <p id="main-cycle-range" class="text-[11px] font-black text-gray-500 tracking-widest">--/-- ~ --/--</p>
                    <span id="main-cycle-badge" class="text-[9px] bg-white/5 text-gray-400 px-1.5 py-0.5 rounded-md border border-white/5 font-bold">--æ—¥é–“</span>
                </div>
                <button id="settingsBtn" class="p-2 hover:bg-white/10 rounded-full transition active-scale">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </header>

        <main class="max-w-md mx-auto px-4 mt-6 space-y-8">
            <!-- äºˆç®—ã‚«ãƒ¼ãƒ‰ -->
            <section>
                <div class="glass-card p-7 rounded-[2.5rem] shadow-2xl relative overflow-hidden bg-gradient-to-br from-slate-800 to-slate-900 border border-white/10">
                    <div class="relative z-10 space-y-6">
                        <div class="flex justify-between items-start">
                            <div class="space-y-1">
                                <p class="text-[10px] text-blue-400 font-black uppercase tracking-[0.2em]">æœ¬æ—¥äºˆç®—</p>
                                <span class="text-4xl font-bold text-white tracking-tight" id="main-daily-allowance">Â¥0</span>
                            </div>
                            <div class="text-right space-y-1">
                                <p class="text-[10px] text-gray-500 font-black uppercase tracking-[0.2em]">æœ¬æ—¥æ”¯å‡º</p>
                                <span class="text-4xl font-bold text-gray-300 tracking-tight" id="main-spent-today">Â¥0</span>
                            </div>
                        </div>
                        <div class="bg-black/40 rounded-3xl p-5 border border-white/5 text-center">
                            <p class="text-[11px] text-gray-400 font-bold uppercase tracking-[0.2em] mb-1">æœ¬æ—¥ã®ä½™å‰°è³‡é‡‘</p>
                            <span class="text-3xl font-black" id="main-today-balance">Â¥0</span>
                        </div>
                        <div class="pt-4 border-t border-white/10 flex justify-between items-center">
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase font-black tracking-wider mb-1">ä»Šæœˆä½™å‰°è³‡é‡‘</p>
                                <p class="text-2xl font-bold text-gray-100" id="main-remaining-budget">Â¥0</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-gray-500 uppercase font-black tracking-wider mb-1">ç· ã‚ã¾ã§æ®‹ã‚Š</p>
                                <p class="text-2xl font-bold text-gray-100" id="main-days-left">--æ—¥</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- é›†è¨ˆã‚«ãƒ¼ãƒ‰ -->
            <section class="grid grid-cols-2 gap-4">
                <div id="main-trigger-variable" class="bg-slate-900/60 p-6 rounded-[2.2rem] border border-white/5 shadow-inner active-scale cursor-pointer hover:bg-slate-800 transition-colors relative">
                    <p class="text-[10px] uppercase tracking-widest text-gray-500 font-black mb-1">å¤‰å‹•è²»åˆè¨ˆ â†—</p>
                    <p class="text-xl font-black text-rose-500" id="main-total-variable">Â¥0</p>
                </div>
                <div id="main-trigger-savings" class="bg-slate-900/60 p-6 rounded-[2.2rem] border border-white/5 shadow-inner active-scale cursor-pointer hover:bg-slate-800 transition-colors relative">
                    <p class="text-[10px] uppercase tracking-widest text-gray-500 font-black mb-1">è²¯è“„ã‹ã‚‰åˆè¨ˆ â†—</p>
                    <p class="text-xl font-black text-amber-500" id="main-total-savings">Â¥0</p>
                </div>
            </section>

            <!-- å±¥æ­´ -->
            <section class="space-y-4">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-[11px] font-black text-gray-500 uppercase tracking-[0.2em]">Recently Records</h2>
                    <div class="h-px flex-1 bg-white/5 mx-4"></div>
                </div>
                <div id="main-history-list" class="space-y-3"></div>
            </section>
        </main>
    </div>

    <!-- ==========================================
         VIEW 2: ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥é›†è¨ˆç”»é¢
         ========================================== -->
    <div id="view-summary" class="view-hidden animate-fade-in min-h-screen pb-10">
        <header class="bg-black/60 sticky top-0 z-30 backdrop-blur-xl safe-pt px-6 pb-4 border-b border-white/5">
            <div class="max-w-md mx-auto flex items-center gap-4">
                <button onclick="navigateBack()" class="p-2 -ml-2 text-gray-400 active-scale">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <h1 id="summary-title" class="text-lg font-black tracking-tight text-white">é›†è¨ˆ</h1>
            </div>
        </header>

        <main class="max-w-md mx-auto px-4 mt-6 space-y-6">
            <div class="glass-card rounded-[2rem] p-5 flex items-center justify-between shadow-lg">
                <button onclick="changeSummaryMonth(-1)" class="p-3 text-gray-500 active-scale hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M15 19l-7-7 7-7"/></svg></button>
                <div class="text-center">
                    <p id="summary-cycle-range" class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-0.5">--/-- ~ --/--</p>
                    <p id="summary-month-label" class="text-sm font-black text-white">2024å¹´ 2æœˆåˆ†</p>
                </div>
                <button onclick="changeSummaryMonth(1)" class="p-3 text-gray-500 active-scale hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M9 5l7 7-7 7"/></svg></button>
            </div>
            <div id="summary-category-list" class="space-y-3"></div>
        </main>
    </div>

    <!-- ==========================================
         VIEW 3: è©³ç´°æ˜ç´°ç”»é¢
         ========================================== -->
    <div id="view-detail" class="view-hidden animate-fade-in min-h-screen pb-10">
        <header class="bg-black/60 sticky top-0 z-30 backdrop-blur-xl safe-pt px-6 pb-4 border-b border-white/5">
            <div class="max-w-md mx-auto flex items-center gap-4">
                <button onclick="navigateBack()" class="p-2 -ml-2 text-gray-400 active-scale">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <h1 id="detail-title" class="text-lg font-black tracking-tight text-white">ã‚«ãƒ†ã‚´ãƒªãƒ¼è©³ç´°</h1>
            </div>
        </header>
        <main class="max-w-md mx-auto px-4 mt-6">
            <div id="detail-transaction-list" class="space-y-3"></div>
        </main>
    </div>

    <!-- å…±é€šFAB (ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ã¿) -->
    <div id="fab-container" class="fixed bottom-0 left-0 right-0 pointer-events-none flex justify-center pb-8 safe-mb z-40">
        <button id="addBtn" class="pointer-events-auto w-18 h-18 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center active-scale border-[6px] border-black hover:bg-blue-500 p-4 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6v12m6-6H6" />
            </svg>
        </button>
    </div>

    <!-- ==========================================
         MODALS: ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤
         ========================================== -->
    <!-- æ”¯å‡ºå…¥åŠ› -->
    <div id="entryModal" class="fixed inset-0 bg-black/90 z-50 flex items-end justify-center hidden backdrop-blur-md">
        <div class="bg-slate-950 w-full max-w-md rounded-t-[3rem] p-8 pb-12 space-y-8 animate-slide-up shadow-2xl border-t border-white/10 safe-pb">
            <div class="flex justify-between items-center">
                <h3 id="modalTitle" class="text-xl font-black text-white tracking-tight">æ”¯å‡ºã‚’å…¥åŠ›</h3>
                <button id="closeModal" class="text-gray-600 bg-white/5 p-2 rounded-full active-scale">&times;</button>
            </div>
            <input type="hidden" id="editId">
            <div class="space-y-8">
                <div class="text-center">
                    <label class="block text-[10px] text-gray-500 mb-2 uppercase font-black tracking-widest">Amount</label>
                    <div class="flex items-center justify-center gap-2">
                        <span class="text-3xl font-bold text-blue-500">Â¥</span>
                        <input type="number" id="amountInput" inputmode="numeric" placeholder="0" class="text-6xl font-black text-white bg-transparent border-none focus:ring-0 outline-none w-64 text-center placeholder:text-gray-800">
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="bg-white/5 rounded-2xl p-4 border border-white/5 flex items-center justify-between">
                        <label class="text-[10px] text-gray-500 uppercase font-black tracking-widest">Date</label>
                        <input type="date" id="dateInput" class="bg-transparent text-white outline-none font-bold text-sm">
                    </div>
                    <input type="text" id="memoInput" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰" class="w-full bg-white/5 px-6 py-5 rounded-2xl outline-none text-white text-lg font-medium border border-white/5 placeholder:text-gray-700">
                </div>
                <div class="flex p-1 bg-black rounded-2xl border border-white/10">
                    <button class="type-tab-btn flex-1 py-3 rounded-xl font-black text-[10px] transition-all" data-type="variable" id="tabVar">ğŸ›’ å¤‰å‹•è²»</button>
                    <button class="type-tab-btn flex-1 py-3 rounded-xl font-black text-[10px] transition-all" data-type="savings" id="tabSav">ğŸ’° è²¯è“„ã‹ã‚‰</button>
                </div>
                <div id="categoryGrid" class="flex flex-wrap gap-2.5"></div>
                <div class="flex gap-4 pt-6">
                    <button id="deleteEntryBtn" class="hidden flex-1 bg-rose-500/10 text-rose-500 font-black py-5 rounded-[2rem] active-scale">å‰Šé™¤</button>
                    <button id="saveBtn" class="flex-[3] bg-blue-600 text-white font-black py-5 rounded-[2.5rem] shadow-xl text-lg active-scale">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨­å®š -->
    <div id="settingsModal" class="fixed inset-0 bg-black/95 z-50 flex items-center justify-center hidden p-4 backdrop-blur-xl">
        <div class="bg-slate-950 w-full max-w-sm rounded-[3rem] p-10 space-y-10 border border-white/10 safe-pb max-h-[90vh] overflow-y-auto shadow-2xl">
            <h3 class="text-2xl font-black text-center text-white tracking-tight">Settings</h3>
            <div class="space-y-8">
                <div>
                    <label class="text-[10px] text-gray-500 font-black uppercase mb-3 block tracking-widest">æœˆé–“äºˆç®— (Â¥)</label>
                    <input type="number" id="monthlyBudgetInput" inputmode="numeric" class="w-full text-3xl font-black border-b-2 border-white/5 bg-transparent text-white outline-none py-3 focus:border-blue-600 transition-colors">
                </div>
                <div>
                    <label class="text-[10px] text-gray-500 font-black uppercase mb-3 block tracking-widest">ã‚µã‚¤ã‚¯ãƒ«ã®é–‹å§‹æ—¥</label>
                    <input type="number" id="startDayInput" inputmode="numeric" min="1" max="31" class="w-24 text-3xl font-black border-b-2 border-white/5 bg-transparent text-white outline-none py-3 text-center focus:border-blue-600 transition-colors">
                </div>
            </div>
            <div class="space-y-6 pt-6 border-t border-white/5">
                <label class="text-[10px] text-gray-500 font-black uppercase block tracking-widest">Categories Management</label>
                <div id="catManageVar" class="space-y-3"></div>
                <div id="catManageSav" class="space-y-3"></div>
            </div>
            <button id="clearBtn" class="w-full py-4 text-[10px] font-black text-rose-800 tracking-widest transition active-scale uppercase">Clear All Local Data</button>
            <div class="flex gap-4 pt-4">
                <button id="closeSettings" class="flex-1 bg-white/5 text-gray-400 py-5 rounded-[2rem] font-bold">æˆ»ã‚‹</button>
                <button id="saveSettings" class="flex-1 bg-blue-600 text-white py-5 rounded-[2.5rem] font-black shadow-lg">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å‰Šé™¤ç¢ºèª -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black/95 z-[70] flex items-center justify-center hidden p-6 backdrop-blur-xl">
        <div class="bg-slate-900 w-full max-w-xs rounded-[2.5rem] p-10 space-y-8 border border-rose-500/20 text-center shadow-2xl">
            <div class="w-16 h-16 bg-rose-500/10 text-rose-500 rounded-full flex items-center justify-center mx-auto text-2xl font-bold">!</div>
            <h3 class="text-lg font-bold text-white">è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h3>
            <div class="space-y-3">
                <button id="confirmDeleteAction" class="w-full bg-rose-600 text-white py-4 rounded-2xl font-black shadow-lg active-scale">å‰Šé™¤ã™ã‚‹</button>
                <button id="cancelDeleteAction" class="w-full bg-white/5 text-gray-400 py-4 rounded-2xl font-bold active-scale">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼è¿½åŠ ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä»£æ›¿ -->
    <div id="catInputModal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center hidden p-4 backdrop-blur-xl">
        <div class="bg-slate-900 w-full max-w-xs rounded-[2.5rem] p-8 space-y-6 border border-white/10 shadow-2xl">
            <h3 class="text-lg font-bold text-center text-white">ã‚«ãƒ†ã‚´ãƒªãƒ¼è¿½åŠ </h3>
            <input type="text" id="newCatNameInput" placeholder="åç§°ã‚’å…¥åŠ›" class="w-full bg-white/5 rounded-2xl px-6 py-4 outline-none text-white text-lg border border-white/5 focus:border-blue-500">
            <div class="flex gap-3">
                <button id="closeCatInputModal" class="flex-1 bg-white/5 text-gray-400 py-4 rounded-2xl font-bold">ä¸­æ­¢</button>
                <button id="confirmAddCat" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg">æ±ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. STATE & STORAGE
        // ==========================================
        let appState = {
            monthlyBudget: 50000,
            startDay: 25,
            categories: {
                variable: ["ä»•äº‹é£Ÿè²»", "é£Ÿè²»", "æ—¥ç”¨å“", "äº¤é€šè²»", "è¶£å‘³"],
                savings: ["è²¯é‡‘", "æ—…è²»äº¤é€šè²»", "ç—…é™¢", "è‡ªå·±æŠ•è³‡"]
            },
            transactions: []
        };

        const STORAGE_KEY = 'budget_pro_v2_data';
        let viewHistory = ['view-main'];
        let currentType = 'variable';
        let selectedCategory = '';
        let editingId = null;
        let summaryContext = { type: 'variable', date: new Date() };
        let detailContext = { category: '', type: 'variable' };
        let targetCatAddType = 'variable';

        const saveToStorage = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
        const loadFromStorage = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) appState = { ...appState, ...JSON.parse(saved) };
        };

        // ==========================================
        // 2. LOGIC: CYCLE CALCULATIONS
        // ==========================================
        function getCycleInfo(specificDate = new Date()) {
            let year = specificDate.getFullYear();
            let month = specificDate.getMonth();
            // ä»Šæ—¥ã®æ—¥ä»˜ãŒé–‹å§‹æ—¥ã‚ˆã‚Šå‰ãªã‚‰ã€é–‹å§‹æœˆã¯å‰æœˆ
            if (specificDate.getDate() < appState.startDay) { month--; }
            
            let start = new Date(year, month, appState.startDay);
            // æœˆã‚’ã¾ãŸãè£œæ­£
            if (start.getMonth() !== (month + 12) % 12) { start = new Date(year, month + 1, 0); }
            start.setHours(0,0,0,0);
            
            let end = new Date(start.getFullYear(), start.getMonth() + 1, start.getDate());
            end.setDate(end.getDate() - 1);
            end.setHours(23,59,59,999);
            
            const today = new Date(); today.setHours(0,0,0,0);
            const diffTime = end.getTime() - today.getTime();
            const daysLeft = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
            const totalDays = Math.round((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24)) + 1;
            
            return { 
                start, 
                end, 
                daysLeft, 
                totalDays, 
                rangeText: `${start.getMonth()+1}/${start.getDate()} ~ ${end.getMonth()+1}/${end.getDate()}`
            };
        }

        const formatDateForInput = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

        // ==========================================
        // 3. NAVIGATION
        // ==========================================
        function navigateTo(viewId) {
            document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('view-hidden'));
            const target = document.getElementById(viewId);
            if (target) {
                target.classList.remove('view-hidden');
                if (viewHistory[viewHistory.length - 1] !== viewId) {
                    viewHistory.push(viewId);
                }
                document.getElementById('fab-container').classList.toggle('view-hidden', viewId !== 'view-main');
                updateUI();
            }
        }

        function navigateBack() {
            if (viewHistory.length > 1) {
                viewHistory.pop();
                const targetView = viewHistory[viewHistory.length - 1];
                document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('view-hidden'));
                document.getElementById(targetView).classList.remove('view-hidden');
                document.getElementById('fab-container').classList.toggle('view-hidden', targetView !== 'view-main');
                updateUI();
            }
        }

        function navigateToSummary(type) {
            summaryContext.type = type;
            summaryContext.date = new Date();
            navigateTo('view-summary');
        }

        function navigateToDetail(category, type) {
            detailContext.category = category;
            detailContext.type = type;
            navigateTo('view-detail');
        }

        function changeSummaryMonth(dir) {
            const newDate = new Date(summaryContext.date);
            newDate.setMonth(newDate.getMonth() + dir);
            summaryContext.date = newDate;
            updateUI();
        }

        // ==========================================
        // 4. UI RENDERING
        // ==========================================
        function updateUI() {
            const currentView = viewHistory[viewHistory.length - 1];
            if (currentView === 'view-main') renderMain();
            else if (currentView === 'view-summary') renderSummary();
            else if (currentView === 'view-detail') renderDetail();
        }

        function renderMain() {
            const cycle = getCycleInfo();
            const todayStr = formatDateForInput(new Date());
            
            document.getElementById('main-cycle-range').innerText = cycle.rangeText;
            document.getElementById('main-cycle-badge').innerText = `${cycle.totalDays}æ—¥é–“`;

            let varTotal = 0, savTotal = 0, spentToday = 0;
            appState.transactions.forEach(t => {
                const tDate = new Date(t.timestamp);
                const tDateStr = formatDateForInput(tDate);
                if (tDate >= cycle.start && tDate <= cycle.end) {
                    if (t.type === 'variable') varTotal += t.amount;
                    else if (t.type === 'savings') savTotal += t.amount;
                }
                if (t.type === 'variable' && tDateStr === todayStr) spentToday += t.amount;
            });

            const remaining = appState.monthlyBudget - varTotal;
            const daily = Math.floor(remaining / cycle.daysLeft);
            const todaySurplus = Math.floor((remaining + spentToday) / cycle.daysLeft) - spentToday;

            document.getElementById('main-daily-allowance').innerText = `Â¥${daily.toLocaleString()}`;
            document.getElementById('main-spent-today').innerText = `Â¥${spentToday.toLocaleString()}`;
            document.getElementById('main-today-balance').innerText = `Â¥${todaySurplus.toLocaleString()}`;
            document.getElementById('main-today-balance').className = `text-3xl font-black ${todaySurplus < 0 ? 'text-rose-500' : 'text-blue-400'}`;
            document.getElementById('main-remaining-budget').innerText = `Â¥${remaining.toLocaleString()}`;
            document.getElementById('main-days-left').innerText = `${cycle.daysLeft}æ—¥`;
            document.getElementById('main-total-variable').innerText = `Â¥${varTotal.toLocaleString()}`;
            document.getElementById('main-total-savings').innerText = `Â¥${savTotal.toLocaleString()}`;

            const list = document.getElementById('main-history-list');
            const recent = [...appState.transactions].sort((a,b) => b.timestamp - a.timestamp).slice(0, 8);
            list.innerHTML = recent.length ? '' : '<p class="text-center py-10 text-gray-700 text-[10px] italic font-black uppercase tracking-[0.2em]">No Records Found</p>';
            recent.forEach(t => list.appendChild(createItemRow(t)));
        }

        function renderSummary() {
            const cycle = getCycleInfo(summaryContext.date);
            const isVar = summaryContext.type === 'variable';
            document.getElementById('summary-title').innerText = isVar ? 'å¤‰å‹•è²»ã®é›†è¨ˆ' : 'è²¯è“„ã‹ã‚‰ã®é›†è¨ˆ';
            document.getElementById('summary-cycle-range').innerText = cycle.rangeText;
            document.getElementById('summary-month-label').innerText = `${cycle.start.getFullYear()}å¹´ ${cycle.start.getMonth()+1}æœˆåˆ†`;

            const catTotals = {};
            appState.categories[summaryContext.type].forEach(c => catTotals[c] = 0);
            
            appState.transactions.forEach(t => {
                if (t.type === summaryContext.type && t.timestamp >= cycle.start.getTime() && t.timestamp <= cycle.end.getTime()) {
                    if (catTotals[t.category] !== undefined) catTotals[t.category] += t.amount;
                }
            });

            const list = document.getElementById('summary-category-list');
            list.innerHTML = '';
            
            const sortedCats = Object.entries(catTotals).sort((a,b) => b[1] - a[1]);
            
            sortedCats.forEach(([name, total]) => {
                const div = document.createElement('div');
                div.className = "glass-card p-5 rounded-[1.8rem] flex items-center justify-between active-scale cursor-pointer border border-white/5 shadow-md hover:bg-white/5 transition-all";
                div.onclick = () => navigateToDetail(name, summaryContext.type);
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl ${isVar ? 'bg-rose-500/10 text-rose-500' : 'bg-amber-500/10 text-amber-500'} flex items-center justify-center text-[10px] font-black border border-white/5">${name.substring(0,2)}</div>
                        <p class="font-bold text-gray-200 text-[14px]">${name}</p>
                    </div>
                    <p class="font-black text-white text-lg">Â¥${total.toLocaleString()}</p>
                `;
                list.appendChild(div);
            });
        }

        function renderDetail() {
            const cycle = getCycleInfo(summaryContext.date);
            document.getElementById('detail-title').innerText = detailContext.category;
            
            const filtered = appState.transactions.filter(t => 
                t.category === detailContext.category && t.type === detailContext.type &&
                t.timestamp >= cycle.start.getTime() && t.timestamp <= cycle.end.getTime()
            ).sort((a,b) => b.timestamp - a.timestamp);

            const list = document.getElementById('detail-transaction-list');
            list.innerHTML = filtered.length ? '' : '<p class="text-center py-20 text-gray-700 text-xs italic font-black uppercase tracking-widest">No Transactions Found</p>';
            filtered.forEach(t => list.appendChild(createItemRow(t)));
        }

        function createItemRow(t) {
            const div = document.createElement('div');
            div.className = "bg-slate-900/40 p-5 rounded-[1.8rem] flex items-center justify-between border border-white/5 active:bg-white/5 transition-all cursor-pointer active-scale";
            div.onclick = (e) => { e.stopPropagation(); openEditModal(t); };
            const d = new Date(t.timestamp);
            div.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-11 h-11 rounded-2xl ${t.type === 'variable' ? 'bg-blue-600/10 text-blue-500' : 'bg-amber-600/10 text-amber-400'} flex items-center justify-center text-[9px] font-black border border-white/5">${t.category.substring(0,2)}</div>
                    <div>
                        <p class="font-bold text-gray-100 text-[13px]">${t.memo || t.category}</p>
                        <p class="text-[9px] text-gray-600 font-black mt-1 uppercase tracking-tighter">${d.getMonth()+1}/${d.getDate()} â€¢ ${t.category}</p>
                    </div>
                </div>
                <p class="font-bold text-gray-100 text-sm">Â¥${t.amount.toLocaleString()}</p>
            `;
            return div;
        }

        // ==========================================
        // 5. MODAL LOGIC (ENTRY & SETTINGS)
        // ==========================================
        function openAddModal() {
            editingId = null;
            document.getElementById('modalTitle').innerText = "æ”¯å‡ºã‚’å…¥åŠ›";
            document.getElementById('amountInput').value = '';
            document.getElementById('memoInput').value = '';
            document.getElementById('dateInput').value = formatDateForInput(new Date());
            document.getElementById('deleteEntryBtn').classList.add('hidden');
            document.getElementById('entryModal').classList.remove('hidden');
            switchType('variable');
        }

        function openEditModal(t) {
            editingId = t.id;
            document.getElementById('modalTitle').innerText = "è¨˜éŒ²ã‚’ç·¨é›†";
            document.getElementById('amountInput').value = t.amount;
            document.getElementById('memoInput').value = t.memo;
            document.getElementById('dateInput').value = formatDateForInput(new Date(t.timestamp));
            document.getElementById('deleteEntryBtn').classList.remove('hidden');
            switchType(t.type);
            selectedCategory = t.category;
            renderCategoryGrid();
            document.getElementById('entryModal').classList.remove('hidden');
        }

        function switchType(type) {
            currentType = type;
            const isVar = type === 'variable';
            document.getElementById('tabVar').className = `type-tab-btn flex-1 py-3.5 rounded-xl font-black text-[10px] transition-all ${isVar ? 'bg-slate-800 text-blue-400 shadow-xl' : 'text-gray-700'}`;
            document.getElementById('tabSav').className = `type-tab-btn flex-1 py-3.5 rounded-xl font-black text-[10px] transition-all ${!isVar ? 'bg-slate-800 text-amber-400 shadow-xl' : 'text-gray-700'}`;
            selectedCategory = appState.categories[type][0] || '';
            renderCategoryGrid();
        }

        function renderCategoryGrid() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '';
            appState.categories[currentType].forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `category-chip px-5 py-3 rounded-2xl text-[10px] font-black transition-all ${selectedCategory === cat ? 'active' : 'bg-black text-gray-600'}`;
                btn.innerText = cat;
                btn.onclick = () => { selectedCategory = cat; renderCategoryGrid(); };
                grid.appendChild(btn);
            });
        }

        function saveEntry() {
            const amt = parseInt(document.getElementById('amountInput').value);
            if (!amt || amt <= 0) return;
            const dateStr = document.getElementById('dateInput').value;
            const timestamp = new Date(dateStr).getTime();
            const entry = { id: editingId || Date.now(), amount: amt, memo: document.getElementById('memoInput').value, type: currentType, category: selectedCategory, timestamp: timestamp };
            
            if (editingId) {
                const idx = appState.transactions.findIndex(x => x.id === editingId);
                appState.transactions[idx] = entry;
            } else { appState.transactions.push(entry); }
            
            saveToStorage(); updateUI();
            document.getElementById('entryModal').classList.add('hidden');
        }

        function renderCategoryManagement() {
            const renderList = (type, containerId) => {
                const container = document.getElementById(containerId);
                const title = type === 'variable' ? 'å¤‰å‹•è²»' : 'è²¯è“„ã‹ã‚‰';
                const color = type === 'variable' ? 'text-rose-500' : 'text-amber-500';
                
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <p class="text-[9px] font-black ${color} tracking-widest uppercase">${title}</p>
                        <button onclick="showCatInput('${type}')" class="text-[10px] font-bold bg-white/5 px-3 py-1 rounded-lg border border-white/5 active-scale">ï¼‹è¿½åŠ </button>
                    </div>`;
                    
                appState.categories[type].forEach((cat, idx) => {
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 bg-black p-4 rounded-2xl border border-white/5 mb-2";
                    div.innerHTML = `
                        <input type="text" value="${cat}" class="flex-1 bg-transparent text-sm font-bold text-gray-200 outline-none" onchange="updateCatName('${type}', ${idx}, this.value)">
                        <button class="text-gray-700 hover:text-rose-500 text-xl font-black active-scale" onclick="removeCat('${type}', ${idx})">&times;</button>
                    `;
                    container.appendChild(div);
                });
            };
            renderList('variable', 'catManageVar');
            renderList('savings', 'catManageSav');
        }

        window.showCatInput = (type) => {
            targetCatAddType = type;
            document.getElementById('newCatNameInput').value = '';
            document.getElementById('catInputModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('newCatNameInput').focus(), 100);
        };
        
        window.updateCatName = (type, idx, val) => { if (val.trim()) appState.categories[type][idx] = val.trim(); saveToStorage(); };
        window.removeCat = (type, idx) => {
            if (appState.categories[type].length > 1) {
                appState.categories[type].splice(idx, 1);
                saveToStorage(); renderCategoryManagement();
            }
        };

        // ==========================================
        // 6. INITIALIZATION & EVENTS
        // ==========================================
        function init() {
            loadFromStorage();
            
            // UI Triggers
            document.getElementById('main-trigger-variable').onclick = () => navigateToSummary('variable');
            document.getElementById('main-trigger-savings').onclick = () => navigateToSummary('savings');
            document.getElementById('addBtn').onclick = openAddModal;
            document.getElementById('closeModal').onclick = () => document.getElementById('entryModal').classList.add('hidden');
            document.getElementById('saveBtn').onclick = saveEntry;
            document.getElementById('tabVar').onclick = () => switchType('variable');
            document.getElementById('tabSav').onclick = () => switchType('savings');

            // Settings
            document.getElementById('settingsBtn').onclick = () => {
                document.getElementById('monthlyBudgetInput').value = appState.monthlyBudget;
                document.getElementById('startDayInput').value = appState.startDay;
                renderCategoryManagement();
                document.getElementById('settingsModal').classList.remove('hidden');
            };
            document.getElementById('closeSettings').onclick = () => document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('saveSettings').onclick = () => {
                appState.monthlyBudget = parseInt(document.getElementById('monthlyBudgetInput').value) || 0;
                appState.startDay = parseInt(document.getElementById('startDayInput').value) || 1;
                saveToStorage(); updateUI(); document.getElementById('settingsModal').classList.add('hidden');
            };

            // Cat Input
            document.getElementById('closeCatInputModal').onclick = () => document.getElementById('catInputModal').classList.add('hidden');
            document.getElementById('confirmAddCat').onclick = () => {
                const val = document.getElementById('newCatNameInput').value.trim();
                if (val) {
                    appState.categories[targetCatAddType].push(val);
                    saveToStorage(); renderCategoryManagement();
                    document.getElementById('catInputModal').classList.add('hidden');
                }
            };

            // Delete
            document.getElementById('deleteEntryBtn').onclick = () => document.getElementById('deleteConfirmModal').classList.remove('hidden');
            document.getElementById('cancelDeleteAction').onclick = () => document.getElementById('deleteConfirmModal').classList.add('hidden');
            document.getElementById('confirmDeleteAction').onclick = () => {
                if (editingId) {
                    appState.transactions = appState.transactions.filter(t => t.id !== editingId);
                    saveToStorage(); updateUI();
                    document.getElementById('deleteConfirmModal').classList.add('hidden');
                    document.getElementById('entryModal').classList.add('hidden');
                }
            };

            document.getElementById('clearBtn').onclick = () => {
                if (confirm("å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.clear(); location.reload(); }
            };

            updateUI();
        }

        window.onload = init;
    </script>
</body>
</html>